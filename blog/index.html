
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../backend/yezhoushusuojian/">
      
      
        <link rel="next" href="category/backend/">
      
      
      <link rel="icon" href="../shoe-prints-solid.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Blog - Adoba Open Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#blog" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Adoba Open Docs" class="md-header__button md-logo" aria-label="Adoba Open Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M296 192c-21.1-12.1-42.3-24.2-72-29.3V22.4C257.7 13 311.4 0 352 0c96 0 224 48 224 128s-119.6 96-176 96c-48 0-76-16-104-32M128 32h48v128h-48c-35.3 0-64-28.7-64-64s28.7-64 64-64m104 288c28-16 56-32 104-32 56.4 0 176 16 176 96S384 512 288 512c-40.5 0-94.3-13-128-22.4V349.3c29.7-5.2 50.9-17.3 72-29.4zM64 480c-35.3 0-64-28.7-64-64s28.7-64 64-64h48v128z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Adoba Open Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Blog
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/adobaai/adobaai.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Welcome

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../backend/20250728-egg-ai-intro/" class="md-tabs__link">
          
  
  
  Backend

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Adoba Open Docs" class="md-nav__button md-logo" aria-label="Adoba Open Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M296 192c-21.1-12.1-42.3-24.2-72-29.3V22.4C257.7 13 311.4 0 352 0c96 0 224 48 224 128s-119.6 96-176 96c-48 0-76-16-104-32M128 32h48v128h-48c-35.3 0-64-28.7-64-64s28.7-64 64-64m104 288c28-16 56-32 104-32 56.4 0 176 16 176 96S384 512 288 512c-40.5 0-94.3-13-128-22.4V349.3c29.7-5.2 50.9-17.3 72-29.4zM64 480c-35.3 0-64-28.7-64-64s28.7-64 64-64h48v128z"/></svg>

    </a>
    Adoba Open Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/adobaai/adobaai.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Backend
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Backend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/20250728-egg-ai-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    EGG AI Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/a-case-study-of-mysql-timezones/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A case study of MySQL timezones
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/ai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ai for adobaro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/exploring-our-technology-stack-backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exploring Our Technology Stack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/reflections-on-designing-a-wallet-serivce/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reflections on Designing a Wallet Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/yezhoushusuojian/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    舟夜书所见
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="category/backend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="category/container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="category/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="category/devops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DevOps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="category/event-driven/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event-Driven
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="category/golang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Golang
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="blog">Blog</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://2.gravatar.com/avatar/ad03de7e2489f96ee2ad95d3f92737ac81571ce35bb9c1736c21fec4d7c9b7dc?size=256" alt="Ion Ling">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-11-06 00:00:00+00:00">November 6, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="category/backend/" class="md-meta__link">Backend</a>, 
              <a href="category/database/" class="md-meta__link">Database</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="debugging-that-weird-postgresql-timestamp-issue"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/">Debugging That Weird PostgreSQL Timestamp Issue</a></h2>
<p>Ever run into this situation? You're inserting multiple records in a transaction,
expecting them to have slightly different timestamps, but when you check the database</p>
<ul>
<li>surprise! - they all have the exact same <code>created_at</code> timestamp.</li>
</ul>
<p>I spent hours debugging this issue in production before realizing it wasn't a bug -
it was expected PostgreSQL behavior.</p>
<h3 id="what-youre-probably-seeing"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#what-youre-probably-seeing">What You're Probably Seeing</a></h3>
<p>You have code that looks something like this:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// Inside a transaction</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">RunInTx</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">tx</span><span class="w"> </span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="c1">// Insert first record</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">&quot;INSERT INTO users (name) VALUES ($1) RETURNING created_at&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="c1">// Some processing happens here...</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="c1">// Insert second record</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="s">&quot;INSERT INTO users (name) VALUES ($1) RETURNING created_at&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bob&quot;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="p">})</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="c1">// Later in your code...</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="k">if</span><span class="w"> </span><span class="nx">user1</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">user2</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="c1">// This should be false, but it&#39;s true!</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Timestamps are identical - WTF?&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="understanding-postgresql-timestamp-functions"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#understanding-postgresql-timestamp-functions">Understanding PostgreSQL Timestamp Functions</a></h3>
<p>PostgreSQL provides several timestamp functions, each with different behavior:</p>
<!-- markdownlint-disable MD013 -->

<table>
<thead>
<tr>
<th>Function</th>
<th>When Evaluated</th>
<th>Changes Within Transaction?</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>now()</code></td>
<td>Transaction start</td>
<td>❌ No</td>
<td>Logical transaction consistency</td>
</tr>
<tr>
<td><code>transaction_timestamp()</code></td>
<td>Transaction start</td>
<td>❌ No</td>
<td>Same as <code>now()</code></td>
</tr>
<tr>
<td><code>statement_timestamp()</code></td>
<td>Statement start</td>
<td>❌ No</td>
<td>Per-statement uniqueness</td>
</tr>
<tr>
<td><code>clock_timestamp()</code></td>
<td>Every call</td>
<td>✅ Yes</td>
<td>Real-time precision</td>
</tr>
</tbody>
</table>
<!-- markdownlint-enable -->

<p><strong>Here's the deal</strong>: By default, most database schemas use <code>now()</code> or <code>transaction_timestamp()</code>,
which return the same timestamp for all operations within a single transaction.</p>
<h3 id="the-fix-switch-to-statement_timestamp"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#the-fix-switch-to-statement_timestamp">The Fix: Switch to <code>statement_timestamp()</code></a></h3>
<p>The cleanest solution is to change your database schema to use <code>statement_timestamp()</code>.
This gives you a unique timestamp for each SQL statement
while preserving all the benefits of transaction isolation.</p>
<h4 id="database-migration"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#database-migration">Database Migration</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">-- Replace &#39;your_table_name&#39; with your actual table name</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1">-- Drop existing trigger if it exists</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="k">DROP</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">updated_at</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">your_table_name</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="c1">-- Update default values to use statement_timestamp()</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">your_table_name</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">statement_timestamp</span><span class="p">();</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">your_table_name</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">updated_at</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">statement_timestamp</span><span class="p">();</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="c1">-- Recreate the trigger for automatic updated_at updates</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">updated_at</span><span class="w"> </span><span class="k">BEFORE</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">your_table_name</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">EACH</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">updated_at_statement</span><span class="p">();</span>
</code></pre></div></td></tr></table></div>
<h4 id="before-and-after-comparison"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#before-and-after-comparison">Before and After Comparison</a></h4>
<p><strong>Before (using <code>now()</code>)</strong>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// Both records get timestamp: 2024-01-15 10:30:00.123</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nx">record1</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">record2</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">)</span><span class="w"> </span><span class="c1">// true</span>
</code></pre></div></td></tr></table></div>
<p><strong>After (using <code>statement_timestamp()</code>)</strong>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1">// record1 gets: 2024-01-15 10:30:00.123</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="c1">// record2 gets: 2024-01-15 10:30:00.456</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nx">record1</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">record2</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">)</span><span class="w"> </span><span class="c1">// false</span>
</code></pre></div></td></tr></table></div>
<h3 id="why-statement_timestamp-is-the-best-choice"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#why-statement_timestamp-is-the-best-choice">Why <code>statement_timestamp()</code> is the Best Choice</a></h3>
<ul>
<li>✅ <strong>Per-statement uniqueness</strong>: Each INSERT/UPDATE gets its own timestamp</li>
<li>✅ <strong>Transaction safety</strong>: Maintains ACID properties</li>
<li>✅ <strong>Logical ordering</strong>: Records maintain chronological order</li>
<li>✅ <strong>Performance</strong>: More efficient than <code>clock_timestamp()</code></li>
<li>✅ <strong>Predictable</strong>: Consistent behavior across different database setups</li>
</ul>
<h3 id="alternative-approaches"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#alternative-approaches">Alternative Approaches</a></h3>
<h4 id="1-application-generated-timestamps"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#1-application-generated-timestamps">1. Application-Generated Timestamps</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Go</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nx">record1</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nx">record2</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Microsecond</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ul>
<li><em>Pros</em>: Full control over timestamps</li>
<li><em>Cons</em>: Requires code changes</li>
</ul>
<h4 id="2-use-clock_timestamp"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#2-use-clock_timestamp">2. Use <code>clock_timestamp()</code></a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">your_table_name</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">clock_timestamp</span><span class="p">();</span>
</code></pre></div></td></tr></table></div>
<ul>
<li><em>Pros</em>: Real-time timestamps</li>
<li><em>Cons</em>: Performance overhead, may be too precise</li>
</ul>
<h3 id="testing-your-fix"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#testing-your-fix">Testing Your Fix</a></h3>
<ol>
<li><strong>Verify the migration</strong>: Check that your table columns now use <code>statement_timestamp()</code></li>
<li><strong>Test in isolation</strong>: Insert a few records and verify different timestamps</li>
<li><strong>Test with transactions</strong>: Run your existing transaction logic</li>
<li><strong>Check logs</strong>: Ensure debug logs show different timestamps</li>
<li><strong>Query validation</strong>: Confirm chronological ordering in SELECT queries</li>
</ol>
<h3 id="common-gotchas"><a class="toclink" href="2025/11/06/debugging-that-weird-postgresql-timestamp-issue/#common-gotchas">Common Gotchas</a></h3>
<ul>
<li>⚠️ <strong>Triggers</strong>: Remember to update any automatic timestamp triggers</li>
<li>⚠️ <strong>Default values</strong>: Check other tables that might have similar issues</li>
<li>⚠️ <strong>Time zones</strong>: Ensure your application handles timezone consistently</li>
<li>⚠️ <strong>Precision</strong>: <code>statement_timestamp()</code> still has microsecond precision limits</li>
</ul>
<p>This fix ensures that records inserted within the same transaction
maintain proper chronological ordering while preserving all the benefits of database transactions.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://2.gravatar.com/avatar/ad03de7e2489f96ee2ad95d3f92737ac81571ce35bb9c1736c21fec4d7c9b7dc?size=256" alt="Ion Ling">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-04-12 00:00:00+00:00">April 12, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="category/backend/" class="md-meta__link">Backend</a>, 
              <a href="category/golang/" class="md-meta__link">Golang</a></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="upgrade-golang-to-121"><a class="toclink" href="2024/04/12/upgrade-golang-to-121/">Upgrade Golang to 1.21</a></h2>
<p>日常升级.</p>
<h3 id="changes"><a class="toclink" href="2024/04/12/upgrade-golang-to-121/#changes">Changes</a></h3>
<ul>
<li>Major<ul>
<li>[x] go.mod</li>
<li>[x] Dockerfile</li>
</ul>
</li>
<li>Minor<ul>
<li>[x] Use builtin <code>slices</code>, <code>slog</code></li>
<li>[x] Use builtin <code>context.WithoutCause()</code></li>
</ul>
</li>
</ul>
<h3 id="check"><a class="toclink" href="2024/04/12/upgrade-golang-to-121/#check">Check</a></h3>
<ul>
<li>[x] Build all apps' image</li>
<li>[x] Call a RPC which used <code>context.WithoutCause()</code></li>
</ul>
<h3 id="about-121"><a class="toclink" href="2024/04/12/upgrade-golang-to-121/#about-121">About 1.21</a></h3>
<p>https://tonybai.com/2023/08/20/some-changes-in-go-1-21/</p>
<p>分章分成四个部分:</p>
<ol>
<li>语言本身</li>
<li>编译器与运行时</li>
<li>工具链</li>
<li>标准库</li>
</ol>
<p>其中比较重要的有: loopvar, GC 优化, slog, 以及兼容性部分</p>
<h4 id="kimi"><a class="toclink" href="2024/04/12/upgrade-golang-to-121/#kimi">Kimi</a></h4>
<p>总结文章, 给出大纲以及重点, 使用 Markdown 的格式编写:</p>
<p>Go 1.21 版本更新概述:</p>
<ul>
<li>语言变化<ul>
<li>builtin 包新增预定义函数：min、max 和 clear</li>
<li>明确了包初始化顺序算法</li>
<li>增强泛型的类型推断能力</li>
<li>修正 Go1 中的两个“陷阱”：panic(nil)和 for 循环变量</li>
</ul>
</li>
<li>Go 编译器与运行时变化<ul>
<li>PGO 默认开启</li>
<li>降低 GC 尾部延迟</li>
<li>支持 WASI</li>
</ul>
</li>
<li>Go 工具链更新<ul>
<li>向后兼容：扩展和规范化 GODEBUG 的使用</li>
<li>向前兼容：go.mod 文件中的 go line 作为约束规则，引入 toolchain 指示符和 GOTOOLCHAIN 环境变量</li>
</ul>
</li>
<li>Go 标准库更新<ul>
<li>log/slog：结构化日志支持</li>
<li>slices、maps 和 cmp：泛型包加入标准库</li>
<li>其他变化：errors.ErrUnsupported、flag.BoolFunc、
  net 的多路径 TCP 支持、 reflect.ValueOf 优化、sync.OnceFunc 等</li>
</ul>
</li>
<li>参考资料<ul>
<li>Go 1.21 Release Notes</li>
<li>Go 1.21 版本发布博客</li>
<li>兼容性相关博客</li>
<li>Godebug 手册</li>
<li>LoopvarExperiment 页面</li>
<li>如何 Golang Evolves without Breaking Programs 文章</li>
<li>PGO 用户指南</li>
</ul>
</li>
</ul>
<p>这个大纲总结了文章中关于 Go 1.21 版本的主要更新和变化，
包括语言特性的变更、编译器与运行时的改进、工具链的更新以及标准库的新增和改动。
同时，列出了文章末尾提供的参考资料链接，方便读者进一步阅读和了解。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://2.gravatar.com/avatar/ad03de7e2489f96ee2ad95d3f92737ac81571ce35bb9c1736c21fec4d7c9b7dc?size=256" alt="Ion Ling">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-01-15 00:00:00+00:00">January 15, 2024</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="category/devops/" class="md-meta__link">DevOps</a>, 
              <a href="category/database/" class="md-meta__link">Database</a></li>
        
        
          
          <li class="md-meta__item">
            
              5 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="migrate-postgresql-databases-using-pglogical"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/">Migrate PostgreSQL Databases Using pglogical</a></h2>
<h3 id="introduction"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#introduction">Introduction</a></h3>
<p>To reduce the latency of database queries,
we have decided to migrate our Postgres database from one zone to a zone closer to our application.</p>
<h3 id="tldr"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#tldr">TLDR</a></h3>
<p>To minimize application downtime, we have chosen continuous migration using <a href="https://github.com/2ndQuadrant/pglogical">pglogical</a>.</p>
<h4 id="change-config"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#change-config">Change config</a></h4>
<p>We need to modify the database configuration, enable the pglogical extension,
and restart the instance.
If you have multiple databases to migrate,
please check <a href="2024/01/15/migrate-postgresql-databases-using-pglogical/#error-worker-registration-failed">worker registration failed</a>
for configuring <code>max_worker_processes</code> correctly.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">TOML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># Ref https://github.com/2ndQuadrant/pglogical#quick-setup</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="n">wal_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;logical&#39;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="n">max_worker_processes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w">   </span><span class="c1"># one per database needed on provider node</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">                            </span><span class="c1"># one per node needed on subscriber node</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">max_replication_slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w">  </span><span class="c1"># one per node needed on provider node</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">max_wal_senders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w">        </span><span class="c1"># one per node needed on provider node</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="n">shared_preload_libraries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pglogical&#39;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="n">track_commit_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">on # needed for last/first update wins conflict resolution</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">                            </span><span class="c1"># property available in PostgreSQL 9.5+</span>
</code></pre></div></td></tr></table></div>
<p>You can use <code>SHOW</code> to check the config parameter:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">SHOW</span><span class="w"> </span><span class="n">wal_level</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">SHOW</span><span class="w"> </span><span class="n">shared_preload_libraries</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<h4 id="ddl"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#ddl">DDL</a></h4>
<p>To start with pglogical, it's crucial to ensure that the database structures
of both the provider and subscriber are identical.
We employ our <a href="https://github.com/pressly/goose">goose</a> based migration for this purpose.
However when creating a subscription using <code>pglogical.create_subscription()</code>,
you can set the <code>synchronize_structure</code> parameter to <code>true</code>,
but it requres that the owner of these structures also exists in the subscriber.</p>
<h4 id="create-subscription"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#create-subscription">Create subscription</a></h4>
<p>On the provider node:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">-- Create a user for logical replication</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">ROLE</span><span class="w"> </span><span class="n">logicalrep</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">LOGIN</span><span class="p">;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">ALTER</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">logicalrep</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;your_pass&#39;</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="c1">-- Here we use pglogical extentsion</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="k">create</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">pglogical</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="c1">-- The dsn can be blank</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">pglogical</span><span class="p">.</span><span class="n">create_node</span><span class="p">(</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="n">node_name</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;provider1&#39;</span><span class="p">,</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="n">dsn</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="p">);</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="c1">-- Add all tables in public schema to the default replication set</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">pglogical</span><span class="p">.</span><span class="n">replication_set_add_all_tables</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;public&#39;</span><span class="p">]);</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="c1">-- Grant privileges to the logicalrep user</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">logicalrep</span><span class="p">;</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">logicalrep</span><span class="p">;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="n">pglogical</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">logicalrep</span><span class="p">;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">pglogical</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">logicalrep</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>On the subscriber node:</p>
<p>Here we sync the <code>order</code> database.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">pglogical</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">pglogical</span><span class="p">.</span><span class="n">create_node</span><span class="p">(</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">node_name</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sub&#39;</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">dsn</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;dbname=order&#39;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">);</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">-- Create subscription</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">pglogical</span><span class="p">.</span><span class="n">create_subscription</span><span class="p">(</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">subscription_name</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sub_order&#39;</span><span class="p">,</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="n">provider_dsn</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host=your_host port=5432 dbname=order user=logicalrep password=your_pass&#39;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="p">);</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="c1">-- Check it</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="c1">--</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="c1">-- Expected status is `replicating`.</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="c1">-- If not, check the database log for details (provider or subscriber node).</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">pglogical</span><span class="p">.</span><span class="n">show_subscription_status</span><span class="p">();</span>
</code></pre></div></td></tr></table></div>
<h4 id="sync-sequences"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#sync-sequences">Sync sequences</a></h4>
<p>One common mistake people make is forgetting the last values of sequences,
which can lead to duplicated key errors.</p>
<p>We write a script to do this.
The new last value will be 1.1 times the origin, factoring in subscription latency.
The primary SQL statement is:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">-- Get last values</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pg_sequences</span><span class="p">;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1">-- Apply them to subscriber</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="k">ALTER</span><span class="w"> </span><span class="n">SEQUENCE</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">videos_id_seq</span><span class="w"> </span><span class="k">RESTART</span><span class="w"> </span><span class="n">new_value</span><span class="p">;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="c1">-- To check the last value of altered sequences, you can use the following SQL.</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1">-- Note that `SELECT * FROM pg_sequences` will show NULL last value after you alter it.</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">-- Refer to https://gist.github.com/lbbedendo/449ff46d3baa7838b99ec513c2de92a7</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">last_value</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">videos_id_seq</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<h4 id="check-rows"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#check-rows">Check rows</a></h4>
<p>We've crafted a script to verify the equality of
both the row count and a randomly selected subset of rows.
See: <a href="https://gist.github.com/ionling/10f50bf3d77040fa8bb4f6695c23befe">https://gist.github.com/ionling/10f50bf3d77040fa8bb4f6695c23befe</a></p>
<h4 id="drop-subsription"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#drop-subsription">Drop subsription</a></h4>
<p>Once we confirm that the source and target databases are in a consistent state,
we can proceed to drop the subscription.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pglogical</span><span class="p">.</span><span class="n">drop_subscription</span><span class="p">(</span><span class="s1">&#39;sub_order&#39;</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<h3 id="solutions"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#solutions">Solutions</a></h3>
<p>Here, we will explore several solutions for the migration process.</p>
<h4 id="dump-and-restore"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#dump-and-restore">Dump and restore</a></h4>
<p>Dumping the old database and restoring it to the new database is a viable approach.
However, it comes with the drawback of causing a significant downtime, which is undesirable.
During this downtime, tasks such as database restoration, data verification,
and service restarts are necessary, consuming a considerable amount of time.</p>
<h4 id="streaming-replication"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#streaming-replication">Streaming replication</a></h4>
<p>PostgreSQL offers native support for streaming replication,
facilitating continuous synchronization of data from a source database to a new one.
This approach significantly reduces service downtime.
By configuring replication in advance, the migration process only requires restarting services,
making it more efficient and minimizing downtime.</p>
<h4 id="multi-master"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#multi-master">Multi-master</a></h4>
<p>The best solution is to combine the old and new databases in a multi-master cluster.
This allows us to smoothly migrate any service
that relies on the old database to the new without any downtime.</p>
<p>One implementation for achieving this is through the <a href="https://github.com/pgEdge/spock">spock</a> extension.
However, the performance and potential issues of this extension might be a concern.
For more insights, you can refer to the blog post:
<a href="https://www.pgedge.com/blog/achieve-multiactive-data-replication-in-postgresql-with-spock">How to achieve multi-master replication in PostgreSQL with Spock</a></p>
<h4 id="summary"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#summary">Summary</a></h4>
<p>To strike a balance between complexity and functionality,
we ultimately opted for the streaming replication solution.</p>
<p>AWS has a blog on database upgrading that is also useful for migrating:</p>
<ol>
<li><a href="https://aws.amazon.com/cn/blogs/database/part-1-upgrade-your-amazon-rds-for-postgresql-database-comparing-upgrade-approaches/">https://aws.amazon.com/cn/blogs/database/part-1-upgrade-your-amazon-rds-for-postgresql-database-comparing-upgrade-approaches/</a></li>
<li><a href="https://aws.amazon.com/cn/blogs/database/part-2-upgrade-your-amazon-rds-for-postgresql-database-using-the-pglogical-extension/">https://aws.amazon.com/cn/blogs/database/part-2-upgrade-your-amazon-rds-for-postgresql-database-using-the-pglogical-extension/</a></li>
</ol>
<h3 id="notes"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#notes">Notes</a></h3>
<h4 id="could-not-open-relation-with-oid"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#could-not-open-relation-with-oid">Could not open relation with OID</a></h4>
<p>When debugging the subscription, I mistakenly dropped the <a href="https://github.com/2ndQuadrant/pglogical">pglogical</a> extension,
deleted the pglogical schema, and subsequently recreated it.
As a consequence, I encounter a error when running certain pg commands:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>Could not open relation with OID
</code></pre></div></td></tr></table></div>
<p>To resolve it, just reconnect the db.</p>
<p>See <a href="https://github.com/2ndQuadrant/pglogical/issues/347">https://github.com/2ndQuadrant/pglogical/issues/347</a></p>
<h4 id="postgresql-priveledges"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#postgresql-priveledges">PostgreSQL priveledges</a></h4>
<p>Some priveledges are not intuitive, like this:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">SQL</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">GRANT</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">mydb</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">admin</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>grants privileges on the database itself, not things within the database.
admin can now drop the database, still without being able to create tables in schema public.<a href="https://stackoverflow.com/a/74111630/7134763">^1</a></p>
<h4 id="error-worker-registration-failed"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#error-worker-registration-failed">ERROR: worker registration failed</a></h4>
<p>When creating a subscription, we encountered the following error:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>ERROR: worker registration failed, you might want to increase max_worker_processes setting
</code></pre></div></td></tr></table></div>
<p>According to the <a href="https://github.com/2ndQuadrant/pglogical">pglogical</a> README:</p>
<blockquote>
<p>one process per node is needed on the subscriber node.</p>
</blockquote>
<p>After ensuring that we do not exceed the limit,
we started searching for related documents and encountered two conflicting pieces of information.</p>
<p>One, from <a href="https://www.enterprisedb.com/docs/pgd/3.7/pglogical/configuration/">EnterpriseDB</a>,
states:</p>
<blockquote>
<p>One per database + two per subscription on the subscriber (downstream).</p>
</blockquote>
<p>The other, from <a href="https://github.com/2ndQuadrant/pglogical/issues/7">GitHub Issue #7</a>,
mentions:</p>
<blockquote>
<p>One worker needed for the main maintenance process,
one per subscription, one per replicated database,
and during startup, it can need one per any connectable database on top of that.</p>
</blockquote>
<p>If we have two databases with one subscription for each database:</p>
<ul>
<li>According to quote one, we will need <code>2*1 + 2*2 = 6</code> processes.</li>
<li>According to quote two, we will need <code>2*2 = 4</code> processes.</li>
</ul>
<p>Which one is correct? I don't know.</p>
<h4 id="other-tools"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#other-tools">Other tools</a></h4>
<ul>
<li><a href="https://github.com/shayonj/pg_easy_replicate">https://github.com/shayonj/pg_easy_replicate</a></li>
<li><a href="https://bucardo.org/">https://bucardo.org/</a></li>
</ul>
<h3 id="references"><a class="toclink" href="2024/01/15/migrate-postgresql-databases-using-pglogical/#references">References</a></h3>
<ul>
<li><a href="https://aws.amazon.com/cn/blogs/database/postgresql-bi-directional-replication-using-pglogical/">PostgreSQL bi-directional replication using pglogical | AWS Database Blog</a></li>
<li><a href="https://docs.aws.amazon.com/dms/latest/sbs/chap-manageddatabases.postgresql-rds-postgresql-full-load-pglogical.html">pglogical - Database Migration Guide</a></li>
<li><a href="https://engineering.theblueground.com/zero-downtime-postgres-migration-done-right/">Zero downtime Postgres migration, done right</a></li>
<li><a href="https://pankajconnect.medium.com/container-security-tips-for-securing-postgresql-instances-in-docker-9de5d2a932fb">Container Security: Tips for Securing PostgreSQL Instances in Docker | by Pan...</a></li>
<li><a href="https://help.aliyun.com/zh/rds/apsaradb-rds-for-postgresql/use-the-pglogical-extension-for-logical-streaming-replication">如何使用逻辑流复制发布和订阅功能_云数据库 RDS(RDS)-阿里云帮助中心</a></li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://2.gravatar.com/avatar/ad03de7e2489f96ee2ad95d3f92737ac81571ce35bb9c1736c21fec4d7c9b7dc?size=256" alt="Ion Ling">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-11-30 00:00:00+00:00">November 30, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="category/backend/" class="md-meta__link">Backend</a>, 
              <a href="category/container/" class="md-meta__link">Container</a>, 
              <a href="category/devops/" class="md-meta__link">DevOps</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="fix-docker-exec-operation-not-permitted"><a class="toclink" href="2023/11/30/fix-docker-exec-operation-not-permitted/">Fix <code>docker exec</code> operation not permitted</a></h2>
<h3 id="issue"><a class="toclink" href="2023/11/30/fix-docker-exec-operation-not-permitted/#issue">Issue</a></h3>
<p>服务器执行 <code>docker exec</code> 失败</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a># docker exec -it user-ab107i9 sh
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>OCI runtime exec failed: exec failed: unable to start container process: open /dev/pts/0: operation not permitted: unknown
</code></pre></div></td></tr></table></div>
<p>搜索一下发现 Issue:</p>
<p>https://github.com/moby/moby/issues/43969</p>
<p>Issue 中提到这个问题在 <code>runc v1.1.4</code> 中已经修复.
检查一下 <code>runc</code> 版本, 为 <code>1.1.3</code>, ok, 确认为 <code>runc</code> 的问题.
想着要升级 docker 版本会造成服务停止问题, 就没处理.</p>
<p>直到今天 [2023-11-30 Thu] 又想起这个问题,
搜了一下, 发现阿里云的文章提到可以避免业务中断的方法<a href="https://help.aliyun.com/zh/ack/product-overview/announcement-about-fixing-the-runc-vulnerability-cve-2019-5736">^aliyun</a>, 尝试了一下, 没有问题.</p>
<h3 id="solution"><a class="toclink" href="2023/11/30/fix-docker-exec-operation-not-permitted/#solution">Solution</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">## Download runc binary</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1"># https://github.com/opencontainers/runc/releases</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>wget<span class="w"> </span>https://github.com/opencontainers/runc/releases/download/v1.1.10/runc.amd64
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>wget<span class="w"> </span>https://github.com/opencontainers/runc/releases/download/v1.1.10/runc.amd64.asc
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>wget<span class="w"> </span>https://raw.githubusercontent.com/opencontainers/runc/main/runc.keyring
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">## Verify runc binary</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>gpg<span class="w"> </span>--import<span class="w"> </span>runc.keyring
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>gpg<span class="w"> </span>--verify<span class="w"> </span>runc.amd64.asc<span class="w"> </span>runc.amd64
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="c1">## Replace runc</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>docker<span class="w"> </span>info<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>runc<span class="w">         </span><span class="c1"># Show old version info</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>sudo<span class="w"> </span>mv<span class="w"> </span>/usr/bin/runc<span class="w"> </span>/usr/bin/runc_old
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>sudo<span class="w"> </span>cp<span class="w"> </span>runc.amd64<span class="w"> </span>/usr/bin/runc
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>sudo<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/usr/bin/runc
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>docker<span class="w"> </span>info<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>runc<span class="w">         </span><span class="c1"># Show new version info</span>
</code></pre></div></td></tr></table></div>
<p>这样就替换完成了, 对于有问题的容器直接重启就可以了.</p>
<h3 id="about-runc"><a class="toclink" href="2023/11/30/fix-docker-exec-operation-not-permitted/#about-runc">About runc</a></h3>
<p><a href="https://github.com/opencontainers/runc">runc</a> 是最底层的容器运行时.</p>
<p>以最新版的 <code>Docker</code> 为例, 当我们执行运行容器时, <code>Docker</code> 会调用 <a href="https://containerd.io/">containerd</a>,
<code>containerd</code> 再调用 <code>runc</code>, 最后通过 <code>runc</code> 来运行容器.</p>
<p>而 <code>containerd</code> 主要负责以下事情<a href="https://www.qikqiak.com/post/containerd-usage/">^qikqiak</a>:</p>
<ol>
<li>管理容器的生命周期（从创建容器到销毁容器）</li>
<li>拉取/推送容器镜像</li>
<li>存储管理（管理镜像及容器数据的存储）</li>
<li>调用 runc 运行容器（与 runc 等容器运行时交互）</li>
<li>管理容器网络接口及网络</li>
</ol>
<p>架构:</p>
<p><img alt="containerd" src="https://github.com/adobaai/adobaai.github.io/assets/20399569/a63c250c-127a-4134-8c89-1dd7b2fd8711" /></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://2.gravatar.com/avatar/ad03de7e2489f96ee2ad95d3f92737ac81571ce35bb9c1736c21fec4d7c9b7dc?size=256" alt="Ion Ling">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-11-10 00:00:00+00:00">November 10, 2023</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="category/backend/" class="md-meta__link">Backend</a>, 
              <a href="category/event-driven/" class="md-meta__link">Event-Driven</a></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="introduction-to-the-eventbus-service"><a class="toclink" href="2023/11/10/introduction-to-the-eventbus-service/">Introduction to the eventbus service</a></h2>
<p>The eventbus service is the Event-Driven Architecture (EDA) implementation in adoba services.</p>
<h3 id="introduction"><a class="toclink" href="2023/11/10/introduction-to-the-eventbus-service/#introduction">Introduction</a></h3>
<p>Here, Redis Stream data structure serves as the message queue.
In other services, events are added to the stream.
The eventbus service then consumes these messages
and utilizes Remote Procedure Call (RPC) for communication with other services.</p>
<p>See:</p>
<pre class="mermaid"><code>sequenceDiagram
  wallet-&gt;&gt;redis: Add event to stream
  eventbus-&gt;&gt;redis: Read stream
  eventbus-&gt;&gt;order: Call RPC</code></pre>
<p>In the past, the prevailing practice was to develop a sidecar queue service,
like <code>strandq</code> or <code>studioq</code>, for each individual service.
However, this approach introduced redundancy and demanded repetitive effort for each service,
making it both time-consuming and resource-intensive.
Consequently, a more efficient strategy emerged:
consolidating the handling of all events within the eventbus service,
eliminating the need for separate management.
This consolidation encapsulates the core concept of an "eventbus."</p>
<p>When interacting with an external message system, such as Aliyun MNS,
having a dedicated standalone queue service (like <code>strandq</code>) proves advantageous.
This design choice preserves the conciseness of the eventbus service
and aligns with the single responsibility principle, ensuring clear and modular responsibilities.</p>
<h3 id="why-event-driven"><a class="toclink" href="2023/11/10/introduction-to-the-eventbus-service/#why-event-driven">Why Event-Driven</a></h3>
<p>Let's talk about the drawbacks first.
The big one is that event-driven architecture makes the system more complex,
and we have to spend more time developing a new feature.</p>
<p>But advantages are more!</p>
<p>Advantages of Event-Driven Architecture:</p>
<ol>
<li>
<p><strong>Loose Coupling</strong>:
   EDA promotes loose coupling between different components of a system.
   Components communicate through events, and they don't need to be aware of each other's existence.
   This characteristic makes it easier to develop, test,
   and maintain individual components independently.</p>
</li>
<li>
<p><strong>Enhanced Fault Tolerance</strong>:
   Since components in an event-driven system are decoupled,
   the failure of one component doesn't necessarily lead to the failure of others.
   Components can continue processing events
   even if some other parts of the system are temporarily unavailable.
   This enhanced fault tolerance ensures system stability during partial failures.</p>
</li>
<li>
<p><strong>Event Replay</strong>:
   The advantage of replay is the ability to reprocess or reevaluate past events.
   This is useful for debugging, testing, correcting data,
   and recovering from errors or failures in a system.</p>
</li>
<li>
<p><strong>Asynchronous Communication</strong>:
   Events in an event-driven system are often communicated asynchronously.
   This enables systems to handle high loads and peak traffic more effectively.
   Components can publish events without waiting for subscribers to process them immediately.
   Asynchronous communication contributes to the scalability and responsiveness of the system.</p>
</li>
<li>
<p><strong>Improved Inter-Team Collaboration</strong>:
   When two services are controlled by different teams,
   EDA becomes an optimal choice, minimizing conflicts and arguments between teams.
   The loosely coupled nature of EDA allows teams to work more independently
   without directly impacting each other,
   fostering smoother collaboration and reducing potential friction.</p>
</li>
</ol>
<h3 id="design-patterns"><a class="toclink" href="2023/11/10/introduction-to-the-eventbus-service/#design-patterns">Design Patterns</a></h3>
<p>Several design patterns align with Event-Driven Architecture,
further enhancing its suitability for complex systems. Notable patterns include:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/cqrs">CQRS pattern</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing">Event Sourcing pattern</a></li>
</ul>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/adobaai" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "header.autohide", "navigation.tabs"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>